<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Dashboard | Virtual Internship Portal</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .dashboard {
      text-align: center;
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
      max-width: 420px;
      width: calc(100% - 40px); /* responsive */
    }

    @media (max-width: 480px) {
      .dashboard { padding: 20px; }
      h2 { font-size: 20px; }
      h3 { font-size: 16px; }
    }

    h2 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    h3 {
      font-size: 18px;
      color: #aef;
      margin-bottom: 20px;
    }

    .info {
      text-align: left;
      margin-top: 15px;
      line-height: 1.6;
      font-size: 15px;
    }

    .logout-btn {
      margin-top: 25px;
      background: linear-gradient(90deg, #ff4b2b, #ff416c);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: linear-gradient(90deg, #ff416c, #ff4b2b);
      box-shadow: 0 5px 15px rgba(255, 65, 108, 0.4);
      transform: translateY(-2px);
    }

    .back-link {
      display: block;
      color: #fff;
      margin-top: 15px;
      text-decoration: none;
      opacity: 0.8;
      font-size: 14px;
    }

    .back-link:hover {
      opacity: 1;
      text-decoration: underline;
    }
    .browse-btn {
      margin-top: 15px;
      background: linear-gradient(90deg, #ff4b2b, #ff416c);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .browse-btn:hover {
      background: linear-gradient(90deg, #ff416c, #ff4b2b);
      box-shadow: 0 5px 15px rgba(255, 65, 108, 0.4);
      transform: translateY(-2px);
    }
    .notification-btn {
      margin-top: 15px;
      background: linear-gradient(90deg, #fdbb2d, #ffaa00);
      color: #000;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .notification-btn:hover {
      background: linear-gradient(90deg, #ffaa00, #fdbb2d);
      box-shadow: 0 5px 15px rgba(253, 187, 45, 0.4);
      transform: translateY(-2px);
    }
  </style>
</head>
<body class="auth-center">
  <div class="dashboard">
    <h2 id="welcomeText">Welcome, Student</h2>
    <h3>Your Profile</h3>

    <div class="info" id="profileInfo"></div>
    <h3 style="margin-top:20px;color:#00eaff;">AI Recommended Internships</h3>
    <div id="aiResults" class="info">
    <p>Loading recommendations...</p>
    </div>


    <button class="browse-btn" onclick="browseInternships()">Browse Internships</button>
    <button class="notification-btn" onclick="viewNotifications()">üì¨ Notifications</button>
    <button class="logout-btn" onclick="logout()">Logout</button>
    <a class="back-link" href="index.html">‚Üê Back to Home</a>
  <!-- Chat Toggle Button -->
<div id="chatToggle" onclick="toggleChat()">üí¨</div>

<!-- Chat Window -->
<div id="chatWindow">
  <div id="chatHeader">
    AI Assistant
    <span onclick="toggleChat()">‚úï</span>
  </div>

  <div id="chatBody"></div>

  <div id="chatFooter">
    <input id="chatInput" placeholder="Ask something..." />
    <button onclick="sendMsg()">Send</button>
  </div>
</div>



  <script>
    const studentData = JSON.parse(localStorage.getItem("student"));
    const token = localStorage.getItem("token");

    if (!token || !studentData) {
      alert("Unauthorized! Please log in first.");
      window.location.href = "student_login.html";
    }

    // display info
    document.getElementById("welcomeText").innerText = `Welcome, ${studentData.name || "Student"} üëã`;

    document.getElementById("profileInfo").innerHTML = `
      <strong>Email:</strong> ${studentData.email} <br>
      <strong>Education:</strong> ${studentData.education || "Not specified"} <br>
      <strong>Skills:</strong> ${(studentData.skills || []).join(", ")} <br>
      <strong>Resume:</strong> ${
        studentData.resumeLink
          ? `<a href="${studentData.resumeLink}" target="_blank">View Resume</a>`
          : "Not uploaded"
      }
    `;

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("student");
      alert("Logged out successfully!");
      window.location.href = "index.html";
    }
    
    function browseInternships() {
      window.location.href = "browse_internships.html";
    }
    
    function viewNotifications() {
      window.location.href = "student_notifications.html";
    }
async function loadAIRecommendations() {
  try {
    const res = await fetch(
      `http://localhost:5000/api/internships/recommend/${studentData._id}`
    );
    const data = await res.json();

    const box = document.getElementById("aiResults");
    box.innerHTML = "";

    if (!data.length) {
      box.innerHTML = "<p>No recommendations available.</p>";
      return;
    }

    data.slice(0, 5).forEach(item => {
      const div = document.createElement("div");
      div.style.marginBottom = "15px";
      div.style.padding = "10px";
      div.style.border = "1px solid rgba(255, 255, 255, 0.2)";
      div.style.borderRadius = "8px";
      div.innerHTML = `
        <strong>${item.internship.title}</strong><br>
        Company: ${item.internship.companyId.name}<br>
        Match Score: <b>${item.matchScore}%</b><br>
        <button onclick="applyForInternship('${item.internship._id}')" style="margin-top: 8px; padding: 6px 12px; background: linear-gradient(90deg, #00d4ff, #0099cc); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='linear-gradient(90deg, #0099cc, #00d4ff)'" onmouseout="this.style.background='linear-gradient(90deg, #00d4ff, #0099cc)'">Apply Now</button>
      `;
      box.appendChild(div);
    });
  } catch (err) {
    console.error("AI load error:", err);
  }
}

async function applyForInternship(internshipId) {
  try {
    const res = await fetch("http://localhost:5000/api/applications/apply", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        studentId: studentData._id,
        internshipId: internshipId
      })
    });

    const data = await res.json();
    
    if (!res.ok) {
      alert(data.message || "Failed to apply");
      return;
    }

    alert("Application submitted successfully! üéâ");
    // Reload recommendations after applying
    loadAIRecommendations();
  } catch (err) {
    console.error("Apply error:", err);
    alert("Error submitting application. Please try again.");
  }
}

// call it when dashboard loads
loadAIRecommendations();

function toggleChat() {
  const win = document.getElementById("chatWindow");
  win.style.display = win.style.display === "flex" ? "none" : "flex";
}

async function sendMsg() {
  const input = document.getElementById("chatInput");
  const body = document.getElementById("chatBody");
  const msg = input.value.trim();
  if (!msg) return;

  body.innerHTML += `<div class="msg user">${msg}</div>`;
  input.value = "";

  const res = await fetch("http://localhost:5000/api/ai/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message: msg })
  });

  const data = await res.json();
  body.innerHTML += `<div class="msg ai">${data.reply}</div>`;
  body.scrollTop = body.scrollHeight;
}

  </script>
</body>
</html>
