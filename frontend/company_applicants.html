<!DOCTYPE html>
<html>
<head>
  <title>Applicants</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { background: transparent; color: var(--text); padding: 24px; }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 16px;
      border-radius: 14px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }
    .name { color: var(--accent); font-weight: 600; }
    .actions { display: flex; gap: 10px; margin-top: 10px; }
    .btn-accept {
      background: linear-gradient(90deg, var(--success), #10b981);
      color: #03120a;
      padding: 8px 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      width: auto;
    }
    .btn-accept:hover { filter: brightness(1.05); }
    .btn-reject {
      background: linear-gradient(90deg, var(--danger), #ff8b8b);
      color: #2b0c0c;
      padding: 8px 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      width: auto;
    }
    .btn-reject:hover { filter: brightness(1.05); }
    .status-pending { color: var(--warning); }
    .status-accepted { color: var(--success); }
    .status-rejected { color: var(--danger); }
    .back-link { color: var(--text); text-decoration: none; margin-bottom: 20px; display: inline-block; opacity: 0.8; font-size: 14px; }
    .back-link:hover { opacity: 1; text-decoration: underline; }
  </style>
</head>
<body>

<a class="back-link" href="company_dashboard.html">‚Üê Back to Dashboard</a>
<h2>Applicants</h2>
<div style="margin: 10px 0 20px;">
  <label for="internshipFilter" style="font-size: 13px; opacity: 0.8;">Filter by Internship:</label>
  <select id="internshipFilter" style="margin-left: 8px; padding: 6px; border-radius: 6px; background:#0b1220; color:#fff; border:1px solid rgba(255,255,255,0.2);">
    <option value="all">All</option>
  </select>
</div>
<div id="list"></div>

<script>
const company = JSON.parse(localStorage.getItem("company"));
const token = localStorage.getItem("companyToken");

console.log("Company:", company);
console.log("Company ID:", company?._id);

if (!company || !company._id) {
  document.getElementById("list").innerHTML = "<p style='color:red;'>Error: Company not logged in. Please log in first.</p>";
} else {
  fetch(`https://virtual-intership-portal.onrender.com/api/applications/company/${company._id}`, {
    headers: {
      "Authorization": "Bearer " + token
    }
  })
  .then(res => {
    console.log("Response status:", res.status);
    return res.json();
  })
  .then(data => {
    console.log("API Response:", data);
    const box = document.getElementById("list");
    const filter = document.getElementById("internshipFilter");

    if (!Array.isArray(data)) {
      box.innerHTML = `<p style='color:red;'>Error: ${data.error || JSON.stringify(data)}</p>`;
      return;
    }

    const internshipMap = new Map();
    data.forEach(app => {
      const id = app.internshipId?._id;
      const title = app.internshipId?.title || "Unknown Internship";
      if (id && !internshipMap.has(id)) internshipMap.set(id, title);
    });

    filter.innerHTML = `<option value="all">All</option>`;
    Array.from(internshipMap.entries()).forEach(([id, title]) => {
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = title;
      filter.appendChild(opt);
    });

    const render = (apps) => {
      box.innerHTML = "";
      if (!apps.length) {
        box.innerHTML = "<p>No applications yet.</p>";
        return;
      }

      apps.forEach(app => {
        const div = document.createElement("div");
        div.className = "card";
        const statusClass = `status-${app.status}`;
        const buttonsHTML = app.status === 'pending' ? `
          <div class="actions">
            <button class="btn-accept" onclick="updateStatus('${app._id}', 'accepted')">Accept</button>
            <button class="btn-reject" onclick="updateStatus('${app._id}', 'rejected')">Reject</button>
          </div>
        ` : '';
        div.innerHTML = `
          <div class="name">${app.studentId.name}</div>
          <p>Email: ${app.studentId.email}</p>
          <p>Education: ${app.studentId.education || "-"}</p>
          <p>Skills: ${(app.studentId.skills || []).join(", ")}</p>
          <p>Internship: <b>${app.internshipId.title}</b></p>
          <p>Match Score: <b>${app.matchScore || 0}%</b></p>
          <p>Status: <span class="${statusClass}">${app.status.toUpperCase()}</span></p>
          ${buttonsHTML}
        `;
        box.appendChild(div);
      });
    };

    render(data);

    filter.addEventListener("change", () => {
      const selected = filter.value;
      if (selected === "all") {
        render(data);
      } else {
        render(data.filter(a => a.internshipId?._id === selected));
      }
    });
  })
  .catch(err => {
    console.error("Fetch error:", err);
    document.getElementById("list").innerHTML = `<p style='color:red;'>Error loading applicants: ${err.message}</p>`;
  });
}

function updateStatus(applicationId, status) {
  fetch(`https://virtual-intership-portal.onrender.com/api/applications/${applicationId}/status`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    location.reload();
  })
  .catch(err => {
    console.error("Error updating status:", err);
    alert("Failed to update status");
  });
}
</script>

</body>
</html>
